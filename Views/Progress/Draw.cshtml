@model CarpetProgressTracker.Models.Order
@{
    ViewData["Title"] = "Draw Progress";
    var hasExistingOverlay = !string.IsNullOrEmpty(Model.CurrentOverlayUrl);
    var hasMask = !string.IsNullOrEmpty(Model.MaskImageUrl);
}

<style>
    .draw-page {
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
    }

    .draw-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 1rem;
    }

    .draw-header-info h1 {
        font-size: 1.75rem;
        font-weight: 700;
        color: var(--gray-900);
        margin: 0 0 0.25rem 0;
        letter-spacing: -0.025em;
    }

    .draw-header-info .meta {
        font-size: 0.9375rem;
        color: var(--gray-500);
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .draw-header-info .meta .separator {
        width: 4px;
        height: 4px;
        background: var(--gray-300);
        border-radius: 50%;
    }

    .draw-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1.5rem;
    }

    .draw-card {
        background: #fff;
        border: 1px solid var(--gray-200);
        border-radius: var(--radius-lg);
        box-shadow: var(--shadow-sm);
        overflow: hidden;
        display: flex;
        flex-direction: column;
    }

    .draw-card-header {
        padding: 1rem 1.5rem;
        background: var(--gray-50);
        border-bottom: 1px solid var(--gray-200);
        font-weight: 600;
        font-size: 0.8125rem;
        color: var(--gray-500);
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }

    .draw-card-body {
        padding: 1.5rem;
        flex: 1;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .reference-image-container {
        background: var(--gray-100);
        border-radius: var(--radius);
        padding: 1rem;
        width: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        min-height: 300px;
        max-height: 55vh;
    }

    .reference-image-container img {
        max-width: 100%;
        max-height: 50vh;
        border-radius: var(--radius-sm);
        box-shadow: var(--shadow);
    }

    .drawing-panel {
        display: flex;
        flex-direction: column;
    }

    .toolbar-container {
        padding: 0.875rem 1.25rem;
        background: #fff;
        border-bottom: 1px solid var(--gray-200);
    }

    .tools-bar {
        display: flex;
        align-items: center;
        gap: 1rem;
        width: 100%;
    }

    .tool-group {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .tool-group .btn-group {
        box-shadow: var(--shadow-xs);
    }

    .tool-group .btn-group .btn {
        padding: 0.5rem 0.75rem;
        border-radius: 0;
    }

    .tool-group .btn-group .btn:first-child {
        border-radius: var(--radius) 0 0 var(--radius);
    }

    .tool-group .btn-group .btn:last-child {
        border-radius: 0 var(--radius) var(--radius) 0;
    }

    .tool-group-size {
        flex: 1;
        min-width: 120px;
    }

    .tool-group-size .tool-label {
        font-size: 0.75rem;
        font-weight: 600;
        color: var(--gray-500);
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }

    .tool-group-size .form-range {
        width: 100px;
        cursor: pointer;
    }

    .tool-group-size .brush-size-value {
        min-width: 24px;
        text-align: center;
        font-size: 0.875rem;
        font-weight: 700;
        color: var(--gray-800);
    }

    .color-picker {
        width: 38px;
        height: 38px;
        padding: 3px;
        border: 2px solid var(--gray-300);
        border-radius: var(--radius);
        cursor: pointer;
        transition: all 0.15s ease;
    }

    .color-picker:hover {
        border-color: var(--gray-400);
    }

    .icon-btn {
        width: 42px;
        height: 42px;
        padding: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: var(--radius);
        transition: all 0.15s ease;
    }

    .drawing-area {
        display: flex;
        justify-content: center;
        align-items: center;
        background: var(--gray-100);
        padding: 1.5rem;
        min-height: 300px;
        max-height: 55vh;
        flex: 1;
    }

    .canvas-wrapper {
        position: relative;
        display: inline-block;
        max-width: 100%;
        max-height: calc(55vh - 3rem);
    }

    .canvas-wrapper canvas {
        display: block;
        max-width: 100%;
        max-height: calc(55vh - 3rem);
        height: auto;
        border-radius: var(--radius);
        box-shadow: var(--shadow-md);
    }

    .canvas-wrapper .guide-canvas {
        position: absolute;
        top: 0;
        left: 0;
        z-index: 2;
        pointer-events: none;
    }

    .canvas-wrapper .drawing-canvas {
        position: relative;
        z-index: 1;
        touch-action: none;
        cursor: crosshair;
        background: #fff;
        image-rendering: pixelated;
    }

    .info-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1.5rem;
    }

    .progress-card-body {
        padding: 1.5rem;
    }

    .progress-display {
        display: flex;
        align-items: center;
        gap: 1.5rem;
    }

    .progress-value {
        font-size: 3rem;
        font-weight: 800;
        line-height: 1;
        letter-spacing: -0.03em;
    }

    .progress-value.complete {
        color: var(--success);
    }

    .progress-value.high {
        color: var(--primary);
    }

    .progress-value.medium {
        color: var(--warning);
    }

    .progress-value.low {
        color: var(--danger);
    }

    .progress-bar-wrapper {
        flex: 1;
    }

    .progress-bar-track {
        height: 10px;
        background: var(--gray-200);
        border-radius: 5px;
        overflow: hidden;
    }

    .progress-bar-fill {
        height: 100%;
        border-radius: 5px;
        transition: width 0.3s ease;
    }

    .progress-bar-fill.complete {
        background: linear-gradient(90deg, var(--success) 0%, #4ade80 100%);
    }

    .progress-bar-fill.high {
        background: linear-gradient(90deg, var(--primary) 0%, #818cf8 100%);
    }

    .progress-bar-fill.medium {
        background: linear-gradient(90deg, var(--warning) 0%, #fbbf24 100%);
    }

    .progress-bar-fill.low {
        background: linear-gradient(90deg, var(--danger) 0%, #f87171 100%);
    }

    .loaded-notice {
        margin-top: 1rem;
        padding: 0.875rem 1rem;
        background: var(--success-light);
        border: 1px solid #bbf7d0;
        border-radius: var(--radius);
        color: #166534;
        font-size: 0.875rem;
        font-weight: 500;
        display: flex;
        align-items: center;
        gap: 0.625rem;
    }

    .loaded-notice svg {
        flex-shrink: 0;
        color: var(--success);
    }

    .instructions-card-body {
        padding: 1.5rem;
    }

    .instructions-list {
        list-style: none;
        padding: 0;
        margin: 0;
        display: flex;
        flex-direction: column;
        gap: 0.875rem;
    }

    .instructions-list li {
        display: flex;
        align-items: flex-start;
        gap: 0.75rem;
        font-size: 0.9375rem;
        color: var(--gray-600);
        line-height: 1.5;
    }

    .instructions-list li::before {
        content: '';
        width: 6px;
        height: 6px;
        background: var(--primary);
        border-radius: 50%;
        margin-top: 0.5rem;
        flex-shrink: 0;
    }

    .instructions-list strong {
        color: var(--gray-800);
        font-weight: 600;
    }

    @@media (max-width: 991.98px) {
        .draw-grid,
        .info-grid {
            grid-template-columns: 1fr;
        }
    }

    @@media (max-width: 575.98px) {
        .draw-header {
            flex-direction: column;
            align-items: flex-start;
        }

        .tools-bar {
            flex-wrap: wrap;
            justify-content: flex-end;
            gap: 0.5rem;
        }

        .tool-group {
            flex-shrink: 0;
        }

        .tool-group-size {
            width: 100%;
            order: 10;
            justify-content: flex-end;
            margin-top: 0.25rem;
            flex: none;
        }

        .tool-group-size .form-range {
            flex: 1;
            max-width: 150px;
        }

        .progress-display {
            flex-direction: column;
            align-items: flex-start;
            gap: 1rem;
        }

        .progress-bar-wrapper {
            width: 100%;
        }
    }
</style>

<div class="draw-page">
    <div class="draw-header">
        <div class="draw-header-info">
            <h1>Draw Progress</h1>
            <div class="meta">
                <span>@Model.OrderNumber</span>
                <span class="separator"></span>
                <span>@Model.StandardWidth Ã— @Model.StandardHeight px</span>
            </div>
        </div>
        <a asp-controller="Orders" asp-action="Details" asp-route-id="@Model.Id" class="btn btn-outline-secondary">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 0.5rem;">
                <path d="m15 18-6-6 6-6"/>
            </svg>
            Back to Order
        </a>
    </div>

    <div class="draw-grid">
        <div class="draw-card">
            <div class="draw-card-header">Reference Image</div>
            <div class="draw-card-body">
                <div class="reference-image-container">
                    <img src="@Model.BaseImageUrl" alt="Base Image" />
                </div>
            </div>
        </div>

        <div class="draw-card drawing-panel">
            <div class="toolbar-container">
                <div class="tools-bar">
                    <div class="tool-group">
                        <div class="btn-group" role="group">
                            <button type="button" class="btn btn-primary tool-btn active" data-tool="pen" id="btnPen" title="Pen (solid stroke)">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 19l7-7 3 3-7 7-3-3z"/><path d="M18 13l-1.5-7.5L2 2l3.5 14.5L13 18l5-5z"/><path d="M2 2l7.586 7.586"/><circle cx="11" cy="11" r="2"/></svg>
                            </button>
                            <button type="button" class="btn btn-outline-primary tool-btn" data-tool="pencil" id="btnPencil" title="Pencil (thin, semi-transparent)">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/><path d="m15 5 4 4"/></svg>
                            </button>
                            <button type="button" class="btn btn-outline-primary tool-btn" data-tool="eraser" id="btnEraser" title="Eraser">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m7 21-4.3-4.3c-1-1-1-2.5 0-3.4l9.6-9.6c1-1 2.5-1 3.4 0l5.6 5.6c1 1 1 2.5 0 3.4L13 21"/><path d="M22 21H7"/><path d="m5 11 9 9"/></svg>
                            </button>
                        </div>
                    </div>
                    <div class="tool-group tool-group-size">
                        <span class="tool-label">Size:</span>
                        <input type="range" id="brushSize" min="1" max="50" value="10" class="form-range" />
                        <span id="brushSizeValue" class="fw-bold brush-size-value">10</span>
                    </div>
                    <div class="tool-group" id="colorGroup">
                        <input type="color" id="brushColor" value="#ff0000" class="color-picker" title="Brush Color" />
                    </div>
                    <div class="tool-group">
                        <button type="button" class="btn btn-outline-secondary icon-btn" id="btnUndo" title="Undo">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 7v6h6"/><path d="M21 17a9 9 0 0 0-9-9 9 9 0 0 0-6 2.3L3 13"/></svg>
                        </button>
                        <button type="button" class="btn btn-outline-danger icon-btn" id="btnClear" title="Clear All">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>
                        </button>
                        <button type="button" class="btn btn-success icon-btn" id="btnSubmit" title="Save Progress" aria-label="Save Progress">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>
                        </button>
                    </div>
                </div>
            </div>
            <div class="drawing-area">
                <div class="canvas-wrapper" id="canvasWrapper">
                    <canvas id="drawingCanvas" class="drawing-canvas"></canvas>
                    <canvas id="guideCanvas" class="guide-canvas"></canvas>
                </div>
            </div>
        </div>
    </div>

    <div class="info-grid">
        <div class="draw-card">
            <div class="draw-card-header">Current Progress</div>
            <div class="progress-card-body">
                @{
                    var progressClass = Model.CurrentProgress >= 100 ? "complete" : Model.CurrentProgress >= 50 ? "high" : Model.CurrentProgress >= 25 ? "medium" : "low";
                }
                <div class="progress-display">
                    <div class="progress-value @progressClass">@Model.CurrentProgress%</div>
                    <div class="progress-bar-wrapper">
                        <div class="progress-bar-track">
                            <div class="progress-bar-fill @progressClass" style="width: @Model.CurrentProgress%;"></div>
                        </div>
                    </div>
                </div>
                @if (hasExistingOverlay)
                {
                    <div class="loaded-notice">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
                            <polyline points="22 4 12 14.01 9 11.01"/>
                        </svg>
                        <span>Previous drawing loaded. Continue from where you left off.</span>
                    </div>
                }
            </div>
        </div>

        <div class="draw-card">
            <div class="draw-card-header">Instructions</div>
            <div class="instructions-card-body">
                <ul class="instructions-list">
                    <li>Use <strong>Pen</strong> for solid strokes or <strong>Pencil</strong> for light marking</li>
                    <li>Use <strong>Eraser</strong> to remove mistakes</li>
                    <li>Drawing is restricted to inside the carpet outline</li>
                    <li>Click <strong>Save</strong> to calculate and store progress</li>
                </ul>
            </div>
        </div>
    </div>

    <form id="submitForm" asp-action="SubmitDraw" method="post" enctype="multipart/form-data" style="display: none;">
        @Html.AntiForgeryToken()
        <input type="hidden" name="orderId" value="@Model.Id" />
        <input type="file" name="overlayImage" id="overlayImageInput" />
    </form>
</div>

<canvas id="maskCanvas" style="display: none;"></canvas>

<script>
(function() {
    var drawingCanvas = document.getElementById('drawingCanvas');
    var drawingCtx = drawingCanvas.getContext('2d', { willReadFrequently: true });
    var guideCanvas = document.getElementById('guideCanvas');
    var guideCtx = guideCanvas.getContext('2d', { willReadFrequently: true });
    var maskCanvas = document.getElementById('maskCanvas');
    var maskCtx = maskCanvas.getContext('2d', { willReadFrequently: true });
    var canvasWrapper = document.getElementById('canvasWrapper');

    var width = @Model.StandardWidth;
    var height = @Model.StandardHeight;

    drawingCanvas.width = width;
    drawingCanvas.height = height;
    guideCanvas.width = width;
    guideCanvas.height = height;
    maskCanvas.width = width;
    maskCanvas.height = height;

    var maskData = null;
    var maskLoaded = false;

    function getDisplayScale() {
        var rect = drawingCanvas.getBoundingClientRect();
        return rect.width / width;
    }

    function syncGuideCanvasSize() {
        var rect = drawingCanvas.getBoundingClientRect();
        guideCanvas.style.width = rect.width + 'px';
        guideCanvas.style.height = rect.height + 'px';
    }

    window.addEventListener('resize', syncGuideCanvasSize);
    setTimeout(syncGuideCanvasSize, 100);

    @if (hasMask)
    {
        <text>
    var maskImg = new Image();
    maskImg.crossOrigin = 'anonymous';
    maskImg.onload = function() {
        maskCtx.drawImage(maskImg, 0, 0, width, height);
        maskData = maskCtx.getImageData(0, 0, width, height);
        maskLoaded = true;
        drawGuideOutline();
        fillOutsideMask();
        syncGuideCanvasSize();
    };
    maskImg.src = '@Model.MaskImageUrl';
        </text>
    }

    function isInWorkArea(x, y) {
        if (!maskLoaded || !maskData) return true;
        x = Math.floor(x);
        y = Math.floor(y);
        if (x < 0 || x >= width || y < 0 || y >= height) return false;
        var idx = (y * width + x) * 4;
        return maskData.data[idx] > 128;
    }

    function drawGuideOutline() {
        if (!maskData) return;
        guideCtx.clearRect(0, 0, width, height);

        var outlinePixels = [];

        for (var y = 0; y < height; y++) {
            for (var x = 0; x < width; x++) {
                var idx = (y * width + x) * 4;
                var isWork = maskData.data[idx] > 128;
                if (!isWork) continue;

                var isEdge = false;
                if (x === 0 || x === width - 1 || y === 0 || y === height - 1) {
                    isEdge = true;
                } else {
                    var neighbors = [
                        (y * width + (x - 1)) * 4,
                        (y * width + (x + 1)) * 4,
                        ((y - 1) * width + x) * 4,
                        ((y + 1) * width + x) * 4
                    ];
                    for (var i = 0; i < neighbors.length; i++) {
                        if (maskData.data[neighbors[i]] <= 128) {
                            isEdge = true;
                            break;
                        }
                    }
                }
                if (isEdge) {
                    outlinePixels.push({ x: x, y: y });
                }
            }
        }

        guideCtx.fillStyle = 'rgba(30, 41, 59, 0.8)';
        for (var i = 0; i < outlinePixels.length; i++) {
            guideCtx.fillRect(outlinePixels[i].x, outlinePixels[i].y, 1, 1);
        }
    }

    function fillOutsideMask() {
        if (!maskData) return;
        var imageData = drawingCtx.getImageData(0, 0, width, height);
        var data = imageData.data;

        for (var y = 0; y < height; y++) {
            for (var x = 0; x < width; x++) {
                var idx = (y * width + x) * 4;
                if (maskData.data[idx] <= 128) {
                    data[idx] = 240;
                    data[idx + 1] = 240;
                    data[idx + 2] = 240;
                    data[idx + 3] = 255;
                }
            }
        }
        drawingCtx.putImageData(imageData, 0, 0);
    }

    @if (hasExistingOverlay)
{
@:    var existingOverlay = new Image();
@:    existingOverlay.crossOrigin = 'anonymous';
@:    existingOverlay.onload = function() {
@:        drawingCtx.drawImage(existingOverlay, 0, 0, width, height);
@:        var imageData = drawingCtx.getImageData(0, 0, width, height);
@:        var data = imageData.data;
@:        for (var y = 0; y < height; y++) {
@:            for (var x = 0; x < width; x++) {
@:                var idx = (y * width + x) * 4;
@:                var inWorkArea = !maskLoaded || !maskData || maskData.data[idx] > 128;
@:                if (inWorkArea && data[idx] > 240 && data[idx + 1] > 240 && data[idx + 2] > 240) {
@:                    data[idx + 3] = 0;
@:                }
@:            }
@:        }
@:        drawingCtx.putImageData(imageData, 0, 0);
@:        if (maskLoaded) {
@:            fillOutsideMask();
@:        }
@:    };
@:    existingOverlay.src = '@Model.CurrentOverlayUrl';
}

    var isDrawing = false;
    var lastX = 0;
    var lastY = 0;
    var history = [];
    var currentTool = 'pen';
    var pencilOnly = false;

    function saveState() {
        if (history.length > 20) history.shift();
        history.push(drawingCanvas.toDataURL());
    }

    setTimeout(function() { saveState(); }, 500);

    function getBrushSize() {
        return parseInt(document.getElementById('brushSize').value);
    }

    function getScaledBrushSize() {
        var baseSize = getBrushSize();
        var scale = getDisplayScale();
        return Math.max(1, Math.round(baseSize / scale));
    }

    function getBrushColor() {
        return document.getElementById('brushColor').value;
    }

    function setActiveTool(tool) {
        currentTool = tool;
        document.querySelectorAll('.tool-btn').forEach(function(btn) {
            if (btn.getAttribute('data-tool') === tool) {
                btn.classList.remove('btn-outline-primary');
                btn.classList.add('btn-primary', 'active');
            } else {
                btn.classList.remove('btn-primary', 'active');
                btn.classList.add('btn-outline-primary');
            }
        });
        var colorGroup = document.getElementById('colorGroup');
        if (tool === 'eraser') {
            colorGroup.style.opacity = '0.5';
            colorGroup.style.pointerEvents = 'none';
        } else {
            colorGroup.style.opacity = '1';
            colorGroup.style.pointerEvents = 'auto';
        }
    }

    document.querySelectorAll('.tool-btn').forEach(function(btn) {
        btn.addEventListener('click', function() {
            setActiveTool(this.getAttribute('data-tool'));
        });
    });

    document.getElementById('brushSize').addEventListener('input', function() {
        document.getElementById('brushSizeValue').textContent = this.value;
    });

    function getPointerPos(e) {
        var rect = drawingCanvas.getBoundingClientRect();
        var scaleX = drawingCanvas.width / rect.width;
        var scaleY = drawingCanvas.height / rect.height;
        var clientX = e.clientX;
        var clientY = e.clientY;
        if (e.touches && e.touches.length > 0) {
            clientX = e.touches[0].clientX;
            clientY = e.touches[0].clientY;
        }
        return {
            x: (clientX - rect.left) * scaleX,
            y: (clientY - rect.top) * scaleY
        };
    }

    function getToolSettings() {
        var baseSize = getScaledBrushSize();
        var settings = {
            size: baseSize,
            alpha: 1.0,
            composite: 'source-over'
        };
        if (currentTool === 'pencil') {
            settings.size = Math.max(1, Math.floor(baseSize * 0.5));
            settings.alpha = 0.4;
        } else if (currentTool === 'eraser') {
            settings.composite = 'destination-out';
        }
        return settings;
    }

    function getPressure(e) {
        if (e && typeof e.pressure === "number" && e.pressure > 0) return e.pressure;
        return 0.5;
    }

    function getDynamicBrushSize(e) {
        var base = getScaledBrushSize();
        if (currentTool === "pencil") return Math.max(1, Math.floor(base * 0.6));
        if (currentTool === "eraser") return Math.max(1, Math.floor(base * 1.2));
        var p = getPressure(e);
        return Math.max(1, Math.round(base * (0.6 + p * 0.9)));
    }

    function shouldAcceptPointer(e) {
        if (!pencilOnly) return true;
        return e && e.pointerType === "pen";
    }

    function drawPoint(x, y, evt) {
        var settings = getToolSettings();
        var dynamicSize = evt ? getDynamicBrushSize(evt) : settings.size;
        var halfBrush = dynamicSize / 2;

        drawingCtx.save();
        drawingCtx.globalAlpha = settings.alpha;
        drawingCtx.globalCompositeOperation = settings.composite;

        for (var dy = -halfBrush; dy <= halfBrush; dy++) {
            for (var dx = -halfBrush; dx <= halfBrush; dx++) {
                if (dx * dx + dy * dy <= halfBrush * halfBrush) {
                    var px = Math.floor(x + dx);
                    var py = Math.floor(y + dy);
                    if (isInWorkArea(px, py)) {
                        drawingCtx.fillStyle = (currentTool === 'eraser') ? 'rgba(0,0,0,1)' : getBrushColor();
                        drawingCtx.fillRect(px, py, 1, 1);
                    }
                }
            }
        }

        drawingCtx.restore();
    }

    function drawLine(x1, y1, x2, y2, evt) {
        var dx = x2 - x1;
        var dy = y2 - y1;
        var steps = Math.ceil(Math.max(Math.abs(dx), Math.abs(dy)) * 1.5);
        if (steps === 0) {
            drawPoint(x1, y1, evt);
            return;
        }
        var xInc = dx / steps;
        var yInc = dy / steps;
        for (var i = 0; i <= steps; i++) {
            drawPoint(x1 + xInc * i, y1 + yInc * i, evt);
        }
    }

    function handlePointerDown(e) {
        if (!shouldAcceptPointer(e)) return;
        e.preventDefault();
        var pos = getPointerPos(e);
        if (!isInWorkArea(pos.x, pos.y)) return;
        saveState();
        isDrawing = true;
        lastX = pos.x;
        lastY = pos.y;
        drawPoint(pos.x, pos.y, e);
    }

    function handlePointerMove(e) {
        if (!isDrawing) return;
        if (!shouldAcceptPointer(e)) return;
        e.preventDefault();
        var pos = getPointerPos(e);
        drawLine(lastX, lastY, pos.x, pos.y, e);
        lastX = pos.x;
        lastY = pos.y;
    }

    function handlePointerUp() {
        isDrawing = false;
    }

    drawingCanvas.addEventListener('pointerdown', handlePointerDown);
    drawingCanvas.addEventListener('pointermove', handlePointerMove);
    drawingCanvas.addEventListener('pointerup', handlePointerUp);
    drawingCanvas.addEventListener('pointerleave', handlePointerUp);
    drawingCanvas.addEventListener('pointercancel', handlePointerUp);

    drawingCanvas.addEventListener('touchstart', function(e) { e.preventDefault(); }, { passive: false });
    drawingCanvas.addEventListener('touchmove', function(e) { e.preventDefault(); }, { passive: false });

    var btnClear = document.getElementById('btnClear');
    btnClear.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();

        saveState();
        drawingCtx.clearRect(0, 0, width, height);

        if (maskLoaded) {
            fillOutsideMask();
        }
    });

    document.getElementById('btnUndo').addEventListener('click', function() {
        if (history.length > 1) {
            history.pop();
            var imgData = history[history.length - 1];
            var img = new Image();
            img.onload = function() {
                drawingCtx.clearRect(0, 0, width, height);
                drawingCtx.drawImage(img, 0, 0);
            };
            img.src = imgData;
        }
    });

    var isSaving = false;
    var saveBtn = document.getElementById('btnSubmit');

    function hasDrawnPixels() {
        var imageData = drawingCtx.getImageData(0, 0, width, height);
        var data = imageData.data;
        for (var y = 0; y < height; y++) {
            for (var x = 0; x < width; x++) {
                var idx = (y * width + x) * 4;
                var inWorkArea = !maskLoaded || !maskData || maskData.data[idx] > 128;
                if (inWorkArea) {
                    var a = data[idx + 3];
                    if (a > 10) {
                        return true;
                    }
                }
            }
        }
        return false;
    }

    function doSave() {
        isSaving = true;
        saveBtn.disabled = true;
        saveBtn.classList.add('saving');
        saveBtn.innerHTML = '<svg class="spin" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12a9 9 0 1 1-6.219-8.56"/></svg>';
        showLoading('Calculating progress...');

        var exportCanvas = document.createElement('canvas');
        exportCanvas.width = width;
        exportCanvas.height = height;
        var exportCtx = exportCanvas.getContext('2d');
        exportCtx.drawImage(drawingCanvas, 0, 0);

        var imageData = exportCtx.getImageData(0, 0, width, height);
        var data = imageData.data;
        for (var y = 0; y < height; y++) {
            for (var x = 0; x < width; x++) {
                var idx = (y * width + x) * 4;
                var inWorkArea = !maskLoaded || !maskData || maskData.data[idx] > 128;
                if (!inWorkArea) {
                    data[idx] = 240;
                    data[idx + 1] = 240;
                    data[idx + 2] = 240;
                    data[idx + 3] = 255;
                }
            }
        }
        exportCtx.putImageData(imageData, 0, 0);

        exportCanvas.toBlob(function(blob) {
            var file = new File([blob], 'overlay.png', { type: 'image/png' });
            var dataTransfer = new DataTransfer();
            dataTransfer.items.add(file);
            document.getElementById('overlayImageInput').files = dataTransfer.files;
            document.getElementById('submitForm').submit();
        }, 'image/png');
    }

    saveBtn.addEventListener('click', function() {
        if (isSaving) return;

        if (!hasDrawnPixels()) {
            showConfirmModal({
                title: 'No Drawing Detected',
                message: 'The canvas appears to be empty. Save anyway? If you have existing saved progress, it will be preserved.',
                type: 'warning',
                confirmText: 'Save Anyway',
                cancelText: 'Cancel',
                onConfirm: doSave
            });
            return;
        }

        doSave();
    });
})();
</script>
